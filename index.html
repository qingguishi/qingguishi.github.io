<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书借阅管理系统 - 登录</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .mobile-menu.active {
            max-height: 500px;
        }
        .login-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        }
    </style>
</head>
<body class="login-container min-h-screen flex items-center justify-center">
    <!-- 登录页面 -->
    <div id="loginPage" class="w-full max-w-md px-8 py-12">
        <div class="bg-white rounded-xl shadow-xl p-8 card-hover">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-600 mb-2">
                    <i class="fas fa-book mr-2"></i>图书管理系统
                </h1>
                <p class="text-gray-600">请输入您的账号密码登录系统</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                    <input type="text" id="username" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="请输入用户名">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="请输入密码">
                </div>

                <div id="errorMessage" class="text-red-500 text-sm hidden">
                    <i class="fas fa-exclamation-circle mr-1"></i> 用户名或密码不正确
                </div>

                <button type="submit" id="loginBtn"
                    class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <i class="fas fa-sign-in-alt mr-2"></i>登录
                </button>
            </form>
        </div>
    </div>

    <!-- 主系统页面 (默认隐藏) -->
    <div id="mainSystem" class="hidden w-full">
        <!-- 导航栏 -->
        <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="text-xl font-bold text-indigo-600">
                    <i class="fas fa-book mr-2"></i>图书管理系统
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="#books" class="text-gray-600 hover:text-indigo-600 transition-colors">图书管理</a>
                    <a href="#users" class="text-gray-600 hover:text-indigo-600 transition-colors">用户管理</a>
                    <a href="#borrow" class="text-gray-600 hover:text-indigo-600 transition-colors">借阅管理</a>
                    <a href="#records" class="text-gray-600 hover:text-indigo-600 transition-colors">借阅记录</a>
                    <button id="logoutBtn" class="text-gray-600 hover:text-indigo-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>退出登录
                    </button>
                </div>
                <button class="md:hidden text-gray-600 focus:outline-none" id="mobileMenuButton">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
            
            <!-- 移动端菜单 -->
            <div class="mobile-menu bg-white md:hidden" id="mobileMenu">
                <div class="px-4 py-2 space-y-2">
                    <a href="#books" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded transition-colors">
                        <i class="fas fa-book mr-2"></i>图书管理
                    </a>
                    <a href="#users" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded transition-colors">
                        <i class="fas fa-users mr-2"></i>用户管理
                    </a>
                    <a href="#borrow" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded transition-colors">
                        <i class="fas fa-exchange-alt mr-2"></i>借阅管理
                    </a>
                    <a href="#records" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded transition-colors">
                        <i class="fas fa-history mr-2"></i>借阅记录
                    </a>
                    <button id="logoutBtnMobile" class="block w-full text-left px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <!-- 图书管理 -->
            <section id="books" class="mb-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-book mr-2 text-indigo-600"></i>图书管理
                    </h2>
                    <button id="addBookBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-plus mr-1"></i>添加图书
                    </button>
                </div>

                <!-- 添加图书表单 -->
                <div id="addBookForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">添加新图书</h3>
                    <form id="bookForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="bookTitle" class="block text-sm font-medium text-gray-700 mb-1">书名</label>
                                <input type="text" id="bookTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="bookAuthor" class="block text-sm font-medium text-gray-700 mb-1">作者</label>
                                <input type="text" id="bookAuthor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="bookISBN" class="block text-sm font-medium text-gray-700 mb-1">ISBN</label>
                                <input type="text" id="bookISBN" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="bookQuantity" class="block text-sm font-medium text-gray-700 mb-1">库存数量</label>
                                <input type="number" id="bookQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelBookBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">保存</button>
                        </div>
                    </form>
                </div>

                <!-- 图书列表 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">书名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作者</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ISBN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">库存</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="bookList" class="bg-white divide-y divide-gray-200">
                                <!-- 图书数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 用户管理 -->
            <section id="users" class="mb-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-users mr-2 text-indigo-600"></i>用户管理
                    </h2>
                    <button id="addUserBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-plus mr-1"></i>添加用户
                    </button>
                </div>

                <!-- 添加用户表单 -->
                <div id="addUserForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">添加新用户</h3>
                    <form id="userForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                                <input type="text" id="userName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="userID" class="block text-sm font-medium text-gray-700 mb-1">学号/工号</label>
                                <input type="text" id="userID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">联系方式</label>
                                <input type="tel" id="userPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelUserBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">保存</button>
                        </div>
                    </form>
                </div>

                <!-- 用户列表 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号/工号</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系方式</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="userList" class="bg-white divide-y divide-gray-200">
                                <!-- 用户数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 借阅管理 -->
            <section id="borrow" class="mb-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-exchange-alt mr-2 text-indigo-600"></i>借阅管理
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 借阅表单 -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">借阅图书</h3>
                        <form id="borrowForm" class="space-y-4">
                            <div>
                                <label for="borrowUser" class="block text-sm font-medium text-gray-700 mb-1">选择用户</label>
                                <select id="borrowUser" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">请选择用户</option>
                                    <!-- 用户选项将通过JS动态加载 -->
                                </select>
                            </div>
                            <div>
                                <label for="borrowBook" class="block text-sm font-medium text-gray-700 mb-1">选择图书</label>
                                <select id="borrowBook" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">请选择图书</option>
                                    <!-- 图书选项将通过JS动态加载 -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">借阅日期</label>
                                <input type="text" id="borrowDate" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">确认借阅</button>
                            </div>
                        </form>
                    </div>

                    <!-- 当前借出图书列表 -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">当前借出图书</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">图书</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">借阅日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="borrowedList" class="bg-white divide-y divide-gray-200">
                                    <!-- 借出图书数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 借阅记录 -->
            <section id="records">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-history mr-2 text-indigo-600"></i>借阅记录
                    </h2>
                    <div class="flex items-center">
                        <input type="text" id="searchRecord" placeholder="搜索..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="searchBtn" class="ml-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">图书</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">借阅日期</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">归还日期</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                </tr>
                            </thead>
                            <tbody id="recordList" class="bg-white divide-y divide-gray-200">
                                <!-- 借阅记录数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- 页脚 -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p class="mb-2">created by <a href="https://space.coze.cn" class="text-indigo-300 hover:text-indigo-400">coze space</a></p>
                <p class="text-sm text-gray-400">页面内容均由 AI 生成，仅供参考</p>
            </div>
        </footer>
    </div>

    <script>
        // 默认账号密码
        const DEFAULT_USERNAME = "adminpfk";
        const DEFAULT_PASSWORD = "pfk666";
        
        // 登录状态管理
        function checkLoginStatus() {
            const loginStatus = localStorage.getItem('isLoggedIn');
            if (loginStatus === 'true') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                return true;
            }
            return false;
        }
        
        // 登录表单提交
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            // 验证账号密码
            if (username === DEFAULT_USERNAME && password === DEFAULT_PASSWORD) {
                // 登录成功
                localStorage.setItem('isLoggedIn', 'true');
                errorMessage.classList.add('hidden');
                
                // 显示主系统
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                
                // 初始化主系统
                initializeMainSystem();
            } else {
                // 登录失败
                errorMessage.classList.remove('hidden');
                
                // 防暴力破解机制
                let failedAttempts = parseInt(localStorage.getItem('failedAttempts') || '0') + 1;
                localStorage.setItem('failedAttempts', failedAttempts);
                
                if (failedAttempts >= 3) {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-clock mr-2"></i>请30秒后再试';
                    
                    setTimeout(() => {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>登录';
                        localStorage.removeItem('failedAttempts');
                    }, 30000);
                }
            }
        });
        
        // 退出登录
        function setupLogoutButtons() {
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutBtnMobile = document.getElementById('logoutBtnMobile');
            
            function logout() {
                localStorage.removeItem('isLoggedIn');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainSystem').classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('errorMessage').classList.add('hidden');
            }
            
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            if (logoutBtnMobile) logoutBtnMobile.addEventListener('click', logout);
        }
        
        // 初始化主系统
        function initializeMainSystem() {
            // 数据存储
            let books = JSON.parse(localStorage.getItem('books')) || [];
            let users = JSON.parse(localStorage.getItem('users')) || [];
            let records = JSON.parse(localStorage.getItem('records')) || [];

            // DOM元素
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const addBookBtn = document.getElementById('addBookBtn');
            const addBookForm = document.getElementById('addBookForm');
            const bookForm = document.getElementById('bookForm');
            const cancelBookBtn = document.getElementById('cancelBookBtn');
            const bookList = document.getElementById('bookList');
            const addUserBtn = document.getElementById('addUserBtn');
            const addUserForm = document.getElementById('addUserForm');
            const userForm = document.getElementById('userForm');
            const cancelUserBtn = document.getElementById('cancelUserBtn');
            const userList = document.getElementById('userList');
            const borrowForm = document.getElementById('borrowForm');
            const borrowUser = document.getElementById('borrowUser');
            const borrowBook = document.getElementById('borrowBook');
            const borrowDate = document.getElementById('borrowDate');
            const borrowedList = document.getElementById('borrowedList');
            const recordList = document.getElementById('recordList');
            const searchRecord = document.getElementById('searchRecord');
            const searchBtn = document.getElementById('searchBtn');

            // 设置当前日期
            const today = new Date();
            borrowDate.value = today.toISOString().split('T')[0];
            
            // 加载数据
            renderBooks();
            renderUsers();
            renderBorrowedBooks();
            renderRecords();
            
            // 初始化下拉菜单
            updateUserDropdown();
            updateBookDropdown();
            
            // 移动端菜单切换
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('active');
            });
            
            // 添加图书按钮
            addBookBtn.addEventListener('click', function() {
                addBookForm.classList.remove('hidden');
                bookForm.reset();
            });
            
            // 取消添加图书
            cancelBookBtn.addEventListener('click', function() {
                addBookForm.classList.add('hidden');
            });
            
            // 提交图书表单
            bookForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('bookTitle').value;
                const author = document.getElementById('bookAuthor').value;
                const isbn = document.getElementById('bookISBN').value;
                const quantity = parseInt(document.getElementById('bookQuantity').value);
                
                const newBook = {
                    id: Date.now(),
                    title,
                    author,
                    isbn,
                    quantity
                };
                
                books.push(newBook);
                saveBooks();
                renderBooks();
                updateBookDropdown();
                addBookForm.classList.add('hidden');
                bookForm.reset();
                
                alert('图书添加成功！');
            });
            
            // 添加用户按钮
            addUserBtn.addEventListener('click', function() {
                addUserForm.classList.remove('hidden');
                userForm.reset();
            });
            
            // 取消添加用户
            cancelUserBtn.addEventListener('click', function() {
                addUserForm.classList.add('hidden');
            });
            
            // 提交用户表单
            userForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('userName').value;
                const id = document.getElementById('userID').value;
                const phone = document.getElementById('userPhone').value;
                
                const newUser = {
                    id: Date.now(),
                    name,
                    userId: id,
                    phone
                };
                
                users.push(newUser);
                saveUsers();
                renderUsers();
                updateUserDropdown();
                addUserForm.classList.add('hidden');
                userForm.reset();
                
                alert('用户添加成功！');
            });
            
            // 提交借阅表单
            borrowForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userId = parseInt(borrowUser.value);
                const bookId = parseInt(borrowBook.value);
                const borrowDateValue = borrowDate.value;
                
                if (!userId || !bookId) {
                    alert('请选择用户和图书！');
                    return;
                }
                
                const user = users.find(u => u.id === userId);
                const book = books.find(b => b.id === bookId);
                
                if (book.quantity <= 0) {
                    alert('该图书库存不足！');
                    return;
                }
                
                const newRecord = {
                    id: Date.now(),
                    userId,
                    userName: user.name,
                    bookId,
                    bookTitle: book.title,
                    borrowDate: borrowDateValue,
                    returnDate: null,
                    status: '借出'
                };
                
                // 减少图书库存
                book.quantity--;
                
                records.push(newRecord);
                saveBooks();
                saveRecords();
                renderBooks();
                renderBorrowedBooks();
                renderRecords();
                updateBookDropdown();
                borrowForm.reset();
                borrowDate.value = today.toISOString().split('T')[0];
                
                alert('借阅成功！');
            });
            
            // 搜索借阅记录
            searchBtn.addEventListener('click', function() {
                renderRecords();
            });
            
            searchRecord.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    renderRecords();
                }
            });
            
            // 渲染图书列表
            function renderBooks() {
                bookList.innerHTML = '';
                
                if (books.length === 0) {
                    bookList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无图书数据</td>
                        </tr>
                    `;
                    return;
                }
                
                books.forEach(book => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${book.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${book.author}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${book.isbn}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${book.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editBook(${book.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteBook(${book.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    bookList.appendChild(row);
                });
            }
            
            // 渲染用户列表
            function renderUsers() {
                userList.innerHTML = '';
                
                if (users.length === 0) {
                    userList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无用户数据</td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.userId}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editUser(${user.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    userList.appendChild(row);
                });
            }
            
            // 渲染当前借出图书列表
            function renderBorrowedBooks() {
                borrowedList.innerHTML = '';
                
                const borrowedBooks = records.filter(record => record.status === '借出');
                
                if (borrowedBooks.length === 0) {
                    borrowedList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无借出图书</td>
                        </tr>
                    `;
                    return;
                }
                
                borrowedBooks.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${record.userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${record.bookTitle}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${record.borrowDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="returnBook(${record.id})" class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                归还
                            </button>
                        </td>
                    `;
                    borrowedList.appendChild(row);
                });
            }
            
            // 渲染借阅记录列表
            function renderRecords() {
                recordList.innerHTML = '';
                
                const searchTerm = searchRecord.value.toLowerCase();
                let filteredRecords = records;
                
                if (searchTerm) {
                    filteredRecords = records.filter(record => 
                        record.userName.toLowerCase().includes(searchTerm) || 
                        record.bookTitle.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filteredRecords.length === 0) {
                    recordList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无借阅记录</td>
                        </tr>
                    `;
                    return;
                }
                
                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${record.userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${record.bookTitle}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${record.borrowDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${record.returnDate || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${record.status === '借出' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${record.status}
                            </span>
                        </td>
                    `;
                    recordList.appendChild(row);
                });
            }
            
            // 更新用户下拉菜单
            function updateUserDropdown() {
                borrowUser.innerHTML = '<option value="">请选择用户</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.userId})`;
                    borrowUser.appendChild(option);
                });
            }
            
            // 更新图书下拉菜单
            function updateBookDropdown() {
                borrowBook.innerHTML = '<option value="">请选择图书</option>';
                
                books.forEach(book => {
                    if (book.quantity > 0) {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = `${book.title} (剩余: ${book.quantity})`;
                        borrowBook.appendChild(option);
                    }
                });
            }
            
            // 编辑图书
            window.editBook = function(id) {
                const book = books.find(b => b.id === id);
                if (!book) return;
                
                document.getElementById('bookTitle').value = book.title;
                document.getElementById('bookAuthor').value = book.author;
                document.getElementById('bookISBN').value = book.isbn;
                document.getElementById('bookQuantity').value = book.quantity;
                
                addBookForm.classList.remove('hidden');
                
                // 删除旧记录
                books = books.filter(b => b.id !== id);
                saveBooks();
            }
            
            // 删除图书
            window.deleteBook = function(id) {
                if (confirm('确定要删除这本图书吗？')) {
                    // 检查是否有未归还的记录
                    const hasUnreturned = records.some(record => 
                        record.bookId === id && record.status === '借出'
                    );
                    
                    if (hasUnreturned) {
                        alert('该图书有未归还记录，无法删除！');
                        return;
                    }
                    
                    books = books.filter(book => book.id !== id);
                    saveBooks();
                    renderBooks();
                    updateBookDropdown();
                }
            }
            
            // 编辑用户
            window.editUser = function(id) {
                const user = users.find(u => u.id === id);
                if (!user) return;
                
                document.getElementById('userName').value = user.name;
                document.getElementById('userID').value = user.userId;
                document.getElementById('userPhone').value = user.phone;
                
                addUserForm.classList.remove('hidden');
                
                // 删除旧记录
                users = users.filter(u => u.id !== id);
                saveUsers();
            }
            
            // 删除用户
            window.deleteUser = function(id) {
                if (confirm('确定要删除这个用户吗？')) {
                    // 检查是否有未归还的记录
                    const hasUnreturned = records.some(record => 
                        record.userId === id && record.status === '借出'
                    );
                    
                    if (hasUnreturned) {
                        alert('该用户有未归还图书，无法删除！');
                        return;
                    }
                    
                    users = users.filter(user => user.id !== id);
                    saveUsers();
                    renderUsers();
                    updateUserDropdown();
                }
            }
            
            // 归还图书
            window.returnBook = function(recordId) {
                const today = new Date().toISOString().split('T')[0];
                const record = records.find(r => r.id === recordId);
                
                if (record) {
                    record.returnDate = today;
                    record.status = '已归还';
                    
                    // 增加图书库存
                    const book = books.find(b => b.id === record.bookId);
                    if (book) {
                        book.quantity++;
                    }
                    
                    saveBooks();
                    saveRecords();
                    renderBooks();
                    renderBorrowedBooks();
                    renderRecords();
                    updateBookDropdown();
                    
                    alert('图书归还成功！');
                }
            }
            
            // 保存数据到localStorage
            function saveBooks() {
                localStorage.setItem('books', JSON.stringify(books));
            }
            
            function saveUsers() {
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            function saveRecords() {
                localStorage.setItem('records', JSON.stringify(records));
            }
        }
        
        // 检查登录状态
        if (checkLoginStatus()) {
            initializeMainSystem();
        }
        
        // 设置退出登录按钮
        setupLogoutButtons();
    </script>
</body>
</html>